# NET协议
+ 解决IP地址枯竭和关于路由可拓展性的担忧
+ 需要做特殊配置才能使处于NAT内部的主机能够提供可供互联网访问的服务。为了使NAT正常工作，每个隶属于同一个连接或者关联的双向数据包都必须通过相同的NAT，NAT必须重写每个数据包的寻址信息，以便私有地址空间的系统和internet主机间能够正常通信。
+ NAT需要跟踪per-association/per-connection的连接状态，其操作贯穿多个协议层，并不像传统的路由器，修改IP层地址也需要同时修改传输曾的校验码。

## 工作原理
+ 重写通过路由器的数据包的识别信息，NAT需要重写往一个方向传输的数据包的源IP地址，重写往另一个方向传输的数据包的目的IP地址，这允许传出的数据包的源IP地址变为NAT路由器中面向Internet的网络接口地址，而不是原始主机的接口地址。
+ 大多数的NAT同时执行translation和packet filtering。

## 基本NAT和NAPT
+ 基本NAT只执行IP地址的重写，本质上就是将私有地址改写未一个公共地址，这种类型NAT无助于减少需要使用的IP地址数量，全局可路由的地址数量必须大于等于希望同时访问Internet的内部主机数量。
+ 比较流行的做法是采用NAPT，NAPT使用传输层标识符（TCP和UDP port, ICMP identifier）来确定一个特定的数据包到底和NAT内部的哪台主机关联。（基本NAT替换ip地址，但保留端口号不变，NAPT 有时必须重写端口号， 以避免冲突）
+ 原则上NAT内部使用的私有地址范围不受限制，假使使用全局ip地址，当内部主机访问外部主机时，内部存在ip地址相同的主机，则会屏蔽远端系统，为了避免这种不良情况的发生，保留了三个IPv4地址范围作为私有地址范围使用，10.0.0.0/8,172.16.0.0/12,192.168.0.0/16。
+ NAT在一定程度上提供了类似防火墙的安全性，一条共同的安全策略是，几乎允许所有的传出及其返回流量通过NAT，但几乎阻断所有传入的新连接请求，此行为抑制了试图确定可利用的活动主机的IP地址探测攻击，此外，NAT对外隐藏内部网络的拓扑信息。

## 在NAT环境下的TCP
+ NAT会创建一个内部状态记住当前正在处理的新连接，成为NAT session，这种状态至少包括一个由客户端的源端口号和IP地址组成的条目，成为NAT mapping，当Internet服务器回复时会用到这些信息，服务器会采用客户端初始选择使用的端口号来回复端点，即NAT的外部地址，这种行为被称为端口保留port preservation.
+ 大多数NAT包括一个TCP连接建立的简化版本，并可以区分连接成功还是失败，特别的，NAT在检测到一个传出的SYN数据包后会激活连接计时器，如果回复的ACK数据包在计时器到期之前还未到达，则该会话状态将被清除，如果ACK数据包到达了，计时器将被清除，并创建一个超时较长的会话计时器。
+ probing会发生在较长会话计时的时间内，用以探测会话是否终止。
+ TCP具有保活机制，可以配置发送keepalive数据包，默认发送速率为两个小时。当一个连接被建立或者消除时，允许空闲最大4分钟，因此长期会话时长至少为2h4min，短连接计时器至少未4min。
- [ ] 棘手的问题是P2P应用。一部分程序采用了同时发起连接,simultaneous open，让连接的每一端均作为客户端同时发送SYN数据包。TCP能够响应SYN+ACK的数据包

## 在NAT环境下的UDP
+ UDP没有标识位，例如SYN、FIN和RST这些位来表示一个会话的创建和销毁。此外，一个关联中的参与者也未必完全清楚，UDP不像TCP那样采用一个4元组来标识一个连接，相反，他是基于两个端点的地址/端口号的组合。
+ 为此NAT设计了一个映射计时器 mapping timer，记录的绑定，会在计时器技术时被清除，计时器时间要求至少2min，推荐5min，每当数据包从内部传输到外部时NAT刷新，被称为对外刷新行为，当数据包从外部传输到内部时刷新NAT mapping timer，成为对内刷新行为，后者是可选的，前者必须。

### 注意ip数据包是可以分片的，允许一个ip数据报跨越多个块，其中每个都是作为一个独立的数据报，但是，由于UDP，TCP和ICMP是在IP层之上的，因此除了第一个分片外，其他的分片没有包含端口号信息，而这是保证NAPT正确操作所必需的信息，因此，在一般情况下，分片并不能被NAT或NAPT正确处理。
